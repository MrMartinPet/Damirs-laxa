<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Norden – karta</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{
    margin:0;
    padding:10px;
    font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
    background:#f4f4f4;
  }
  h1{
    text-align:center;
    font-size:1.4rem;
    margin:4px 0 2px;
  }
  .subtitle{
    text-align:center;
    font-size:0.85rem;
    color:#555;
    margin-bottom:8px;
  }
  .map-wrapper{
    max-width:420px;
    margin:0 auto 8px;
    padding:8px;
    background:#fff;
    border-radius:16px;
    box-shadow:0 2px 6px rgba(0,0,0,.15);
  }
  .map{
    position:relative;
    width:100%;
    aspect-ratio:3/4;
    border-radius:12px;
    background:#eee url("nordenkarta.png") center/contain no-repeat;
    overflow:hidden;
  }

  .pin{
    position:absolute;
    width:22px;
    height:22px;
    border-radius:50%;
    background:rgba(0,0,0,.85);
    color:#fff;
    font-size:0.75rem;
    display:flex;
    align-items:center;
    justify-content:center;
    transform:translate(-50%,-50%);
    box-shadow:0 1px 3px rgba(0,0,0,.4);
    cursor:pointer;
  }
  .pin.self-correct{
    background:#2a8f2a;
  }
  .pin.revealed{
    background:#1b6aa8;
  }
  .pin.wrong{
    background:#c33;
  }

  #score{
    max-width:420px;
    margin:0 auto 6px;
    font-size:0.85rem;
    font-weight:600;
    text-align:center;
  }
  #globalButtons{
    max-width:420px;
    margin:0 auto 8px;
    display:flex;
    gap:6px;
  }
  button{
    flex:1;
    padding:8px 0;
    border:none;
    border-radius:999px;
    font-size:0.9rem;
    cursor:pointer;
  }
  #checkAllBtn{ background:#007aff; color:#fff; }
  #resetBtn{ background:#d0d0d0; }

  /* Bottenpanel */
  #panel{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    background:#fff;
    border-radius:18px 18px 0 0;
    box-shadow:0 -2px 10px rgba(0,0,0,.25);
    padding:10px 14px 14px;
    max-width:480px;
    margin:0 auto;
    transform:translateY(100%);
    transition:transform 0.2s ease-out;
  }
  #panel.visible{
    transform:translateY(0);
  }
  #panelTitle{
    font-size:0.95rem;
    font-weight:600;
    margin-bottom:4px;
  }
  #panelHint{
    font-size:0.8rem;
    color:#555;
    margin-bottom:6px;
  }
  #panelFields{
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-bottom:6px;
  }
  .fieldRow{
    display:flex;
    gap:4px;
    align-items:center;
  }
  .fieldLabel{
    font-size:0.8rem;
    width:60px;
  }
  .fieldInput{
    flex:1;
    min-width:120px;
    font-size:0.9rem;
    padding:4px 6px;
    border-radius:6px;
    border:1px solid #aaa;
  }
  .fieldInput.correct{
    border:2px solid #2a8f2a;
    background:#d2f4d2;
  }
  .fieldInput.wrong{
    border:2px solid #c33;
    background:#f8d6d6;
  }
  #panelButtons{
    display:flex;
    gap:6px;
    margin-top:4px;
  }
  #checkPlaceBtn{
    background:#007aff;
    color:#fff;
  }
  #showAnswersBtn{
    background:#ffcc00;
  }
  #closePanelBtn{
    background:#e0e0e0;
  }
  #panelMsg{
    font-size:0.8rem;
    margin-top:4px;
    color:#333;
  }
</style>
</head>
<body>

<h1>Norden – karta</h1>
<div class="subtitle">Tryck på en siffra på kartan, skriv in svaret och kolla platsen.</div>

<div class="map-wrapper">
  <div class="map" id="map"></div>
</div>

<div id="score"></div>

<div id="globalButtons">
  <button id="checkAllBtn">Kolla resultat</button>
  <button id="resetBtn">Nollställ</button>
</div>

<!-- Bottenpanel för aktiv plats -->
<div id="panel">
  <div id="panelTitle"></div>
  <div id="panelHint"></div>
  <div id="panelFields"></div>
  <div id="panelButtons">
    <button id="checkPlaceBtn">Kolla plats</button>
    <button id="showAnswersBtn">Visa rätt svar</button>
    <button id="closePanelBtn">Stäng</button>
  </div>
  <div id="panelMsg"></div>
</div>

<script>
// ======== Hjälpfunktioner =========
function normalize(str){
  return str
    .toLowerCase()
    .trim()
    .replaceAll("å","a")
    .replaceAll("ä","a")
    .replaceAll("ö","o")
    .replaceAll("´","")
    .replaceAll("`","")
    .replaceAll("’","")
    .replace(/[^a-z0-9 ]+/g," ")
    .replace(/\s+/g," ");
}
function cap(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : ""; }

// ======== 19 platser =========
// left/top är grovt anpassade för din bild – finjustera vid behov.
const PLACES = [
  // 1–5: land + huvudstad
  {
    num:1,
    type:"country",
    label:"Sverige / Stockholm",
    left:55, top:65,
    parts:[
      {id:"sverige-land",  label:"Land", answers:["sverige"], isCountryName:true},
      {id:"sverige-stad",  label:"Stad", answers:["stockholm"]}
    ]
  },
  {
    num:2,
    type:"country",
    label:"Norge / Oslo",
    left:37, top:63,
    parts:[
      {id:"norge-land",    label:"Land", answers:["norge"], isCountryName:true},
      {id:"norge-stad",    label:"Stad", answers:["oslo"]}
    ]
  },
  {
    num:3,
    type:"country",
    label:"Danmark / Köpenhamn",
    left:45, top:86,
    parts:[
      {id:"danmark-land",  label:"Land", answers:["danmark"], isCountryName:true},
      {id:"danmark-stad",  label:"Stad", answers:["köpenhamn","kopenhamn","copenhagen"]}
    ]
  },
  {
    num:4,
    type:"country",
    label:"Finland / Helsingfors",
    left:73, top:60,
    parts:[
      {id:"finland-land",  label:"Land", answers:["finland"], isCountryName:true},
      {id:"finland-stad",  label:"Stad", answers:["helsingfors","helsinki"]}
    ]
  },
  {
    num:5,
    type:"country",
    label:"Island / Reykjavik",
    left:18, top:33,
    parts:[
      {id:"island-land",   label:"Land", answers:["island"], isCountryName:true},
      {id:"island-stad",   label:"Stad", answers:["reykjavik","reykjavík"]}
    ]
  },

  // 6–8: öar
  {
    num:6,
    type:"island",
    label:"Ö – Gotland",
    left:63, top:77,
    parts:[
      {id:"gotland", label:"Namn", answers:["gotland"]}
    ]
  },
  {
    num:7,
    type:"island",
    label:"Ö – Öland",
    left:59, top:83,
    parts:[
      {id:"oland", label:"Namn", answers:["öland","oland"]}
    ]
  },
  {
    num:8,
    type:"island",
    label:"Ö – Åland",
    left:60, top:58,
    parts:[
      {id:"aland", label:"Namn", answers:["åland","aland"]}
    ]
  },

  // 9–11: sjöar
  {
    num:9,
    type:"lake",
    label:"Sjö – Vänern",
    left:49, top:69,
    parts:[
      {id:"vanern", label:"Namn", answers:["vänern","vanern"]}
    ]
  },
  {
    num:10,
    type:"lake",
    label:"Sjö – Vättern",
    left:52, top:74,
    parts:[
      {id:"vatttern", label:"Namn", answers:["vättern","vatttern"]}
    ]
  },
  {
    num:11,
    type:"lake",
    label:"Sjö – Mälaren",
    left:56, top:66,
    parts:[
      {id:"malaren", label:"Namn", answers:["mälaren","malaren"]}
    ]
  },

  // 12–19: hav / sund / vikar
  {
    num:12,
    type:"water",
    label:"Hav – Östersjön",
    left:68, top:74,
    parts:[
      {id:"ostersjon", label:"Namn", answers:["östersjön","ostersjon"]}
    ]
  },
  {
    num:13,
    type:"water",
    label:"Hav – Nordsjön",
    left:27, top:69,
    parts:[
      {id:"nordsjon", label:"Namn", answers:["nordsjön","nordsjon"]}
    ]
  },
  {
    num:14,
    type:"water",
    label:"Hav – Bottenhavet",
    left:63, top:52,
    parts:[
      {id:"bottenhavet", label:"Namn", answers:["bottenhavet"]}
    ]
  },
  {
    num:15,
    type:"water",
    label:"Vik – Bottenviken",
    left:65, top:42,
    parts:[
      {id:"bottenviken", label:"Namn", answers:["bottenviken"]}
    ]
  },
  {
    num:16,
    type:"water",
    label:"Vik – Finska viken",
    left:80, top:64,
    parts:[
      {id:"finskaviken", label:"Namn", answers:["finska viken","finskaviken"]}
    ]
  },
  {
    num:17,
    type:"water",
    label:"Sund – Skagerrak",
    left:39, top:72,
    parts:[
      {id:"skagerrak", label:"Namn", answers:["skagerrak"]}
    ]
  },
  {
    num:18,
    type:"water",
    label:"Sund – Kattegatt",
    left:43, top:79,
    parts:[
      {id:"kattegatt", label:"Namn", answers:["kattegatt"]}
    ]
  },
  {
    num:19,
    type:"water",
    label:"Sund – Öresund",
    left:46, top:84,
    parts:[
      {id:"oresund", label:"Namn", answers:["öresund","oresund"]}
    ]
  }
];

// ======== STATE =========
// Ett fält per part (land, stad, namn)
const fields = []; // {placeNum, partId, label, answers, value, correct, revealed}

PLACES.forEach(place=>{
  place.parts.forEach(part=>{
    fields.push({
      placeNum: place.num,
      partId: part.id,
      label: part.label,
      answers: part.answers,
      value: "",
      correct: false,
      revealed: false
    });
  });
});

let activePlaceNum = null;

// ======== Bygg kartan =========
const mapEl = document.getElementById("map");
const scoreEl = document.getElementById("score");

PLACES.forEach(place=>{
  const p = document.createElement("div");
  p.className = "pin";
  p.style.left = place.left + "%";
  p.style.top  = place.top + "%";
  p.textContent = place.num;
  p.dataset.num = place.num;
  p.addEventListener("click", ()=>openPanel(place.num));
  mapEl.appendChild(p);
});

// ======== Panelhantering =========
const panel = document.getElementById("panel");
const panelTitle = document.getElementById("panelTitle");
const panelHint = document.getElementById("panelHint");
const panelFields = document.getElementById("panelFields");
const panelMsg = document.getElementById("panelMsg");

document.getElementById("checkPlaceBtn").addEventListener("click", ()=>{
  if(activePlaceNum!=null){
    readInputsFromPanel();
    checkPlace(activePlaceNum);
    updateScore();
  }
});

document.getElementById("showAnswersBtn").addEventListener("click", ()=>{
  if(activePlaceNum!=null){
    revealPlace(activePlaceNum);
    renderPanelFields(activePlaceNum);
    updatePinClasses(activePlaceNum);
    updateScore();
  }
});

document.getElementById("closePanelBtn").addEventListener("click", ()=>closePanel());

function openPanel(num){
  activePlaceNum = num;
  const place = PLACES.find(p=>p.num===num);
  panelTitle.textContent = `Plats ${num}: ${place.label}`;
  panelHint.textContent = place.type==="country"
    ? "Skriv både land och huvudstad."
    : "Skriv namnet för platsen.";
  panelMsg.textContent = "";
  renderPanelFields(num);
  panel.classList.add("visible");
}

function closePanel(){
  panel.classList.remove("visible");
  activePlaceNum = null;
}

function renderPanelFields(num){
  const placeFields = fields.filter(f=>f.placeNum===num);
  panelFields.innerHTML = "";
  placeFields.forEach(f=>{
    const row = document.createElement("div");
    row.className = "fieldRow";
    const lab = document.createElement("div");
    lab.className = "fieldLabel";
    lab.textContent = f.label;
    const inp = document.createElement("input");
    inp.className = "fieldInput";
    inp.value = f.value;
    if(f.correct){
      inp.classList.add("correct");
    }else if(f.value){
      inp.classList.add("wrong");
    }
    inp.addEventListener("input", e=>{
      f.value = e.target.value;
      f.correct = false;
      // ändrar man efter facit ska den fortfarande räknas som "med hjälp"
      e.target.classList.remove("correct","wrong");
    });
    row.appendChild(lab);
    row.appendChild(inp);
    panelFields.appendChild(row);
  });
}

function readInputsFromPanel(){
  const inputs = panelFields.querySelectorAll(".fieldRow");
  const placeFields = fields.filter(f=>f.placeNum===activePlaceNum);
  inputs.forEach((rowEl, idx)=>{
    const inp = rowEl.querySelector("input");
    const f = placeFields[idx];
    f.value = inp.value;
  });
}

// ======== Rättningslogik =========
function checkPlace(num){
  const place = PLACES.find(p=>p.num===num);
  const placeFields = fields.filter(f=>f.placeNum===num);

  let allCorrect = true;
  let anyAnswered = false;

  placeFields.forEach(f=>{
    const norm = normalize(f.value);
    const ok = f.answers.some(a=>normalize(a)===norm);
    f.correct = ok;
    if(norm!=="") anyAnswered = true;
    if(!ok) allCorrect = false;
  });

  const pin = mapEl.querySelector(`.pin[data-num="${num}"]`);
  pin.classList.remove("self-correct","revealed","wrong");

  const revealedHere = placeFields.some(f=>f.revealed);

  if(allCorrect && anyAnswered){
    if(revealedHere){
      pin.classList.add("revealed");
      panelMsg.textContent = "Rätt – men du har tittat på facit för den här platsen.";
    }else{
      pin.classList.add("self-correct");
      panelMsg.textContent = "Rätt! Bra jobbat.";
    }
  }else if(anyAnswered){
    pin.classList.add("wrong");
    panelMsg.textContent = "Inte helt rätt än.";
  }else{
    panelMsg.textContent = "Skriv ett svar och kolla igen.";
  }

  // uppdatera färger i panelen
  renderPanelFields(num);
}

function revealPlace(num){
  const placeFields = fields.filter(f=>f.placeNum===num);
  placeFields.forEach(f=>{
    f.value = f.answers[0];
    f.correct = true;
    f.revealed = true;
  });
  panelMsg.textContent = "Facit visat – den här platsen räknas som rätt med hjälp.";
}

function updatePinClasses(num){
  const placeFields = fields.filter(f=>f.placeNum===num);
  const pin = mapEl.querySelector(`.pin[data-num="${num}"]`);
  pin.classList.remove("self-correct","revealed","wrong");

  const anyAnswered = placeFields.some(f=>normalize(f.value)!=="");
  const allCorrect = placeFields.every(f=>f.correct);
  const anyRevealed = placeFields.some(f=>f.revealed);

  if(allCorrect && anyAnswered){
    pin.classList.add(anyRevealed ? "revealed" : "self-correct");
  }else if(anyAnswered){
    pin.classList.add("wrong");
  }
}

// ======== Sammanfattning =========
function updateScore(){
  let correctSelf = 0;
  let correctHelp = 0;

  PLACES.forEach(place=>{
    const placeFields = fields.filter(f=>f.placeNum===place.num);
    const anyAnswered = placeFields.some(f=>normalize(f.value)!=="");
    const allCorrect = placeFields.every(f=>f.correct);
    const anyRevealed = placeFields.some(f=>f.revealed);
    if(allCorrect && anyAnswered){
      if(anyRevealed) correctHelp++;
      else correctSelf++;
    }
  });

  const totalPlaces = PLACES.length;
  const totalCorrect = correctSelf + correctHelp;
  scoreEl.textContent =
    `Platser helt rätt: ${totalCorrect} av ${totalPlaces} (själv: ${correctSelf}, med hjälp: ${correctHelp}).`;
}

// ======== Globala knappar =========
document.getElementById("checkAllBtn").addEventListener("click", ()=>{
  PLACES.forEach(p=>{
    const anyAnswered = fields.some(f=>f.placeNum===p.num && normalize(f.value)!=="");
    if(anyAnswered){
      // kontrollera utan att öppna panel
      const placeFields = fields.filter(f=>f.placeNum===p.num);
      let allCorrect = true;
      placeFields.forEach(f=>{
        const norm = normalize(f.value);
        const ok = f.answers.some(a=>normalize(a)===norm);
        f.correct = ok;
        if(!ok) allCorrect = false;
      });
      const anyRevealed = placeFields.some(f=>f.revealed);
      const pin = mapEl.querySelector(`.pin[data-num="${p.num}"]`);
      pin.classList.remove("self-correct","revealed","wrong");
      if(allCorrect){
        pin.classList.add(anyRevealed ? "revealed" : "self-correct");
      }else{
        pin.classList.add("wrong");
      }
    }
  });
  updateScore();
});

document.getElementById("resetBtn").addEventListener("click", ()=>{
  fields.forEach(f=>{
    f.value = "";
    f.correct = false;
    f.revealed = false;
  });
  mapEl.querySelectorAll(".pin").forEach(p=>{
    p.classList.remove("self-correct","revealed","wrong");
  });
  scoreEl.textContent = "";
  panelFields.innerHTML = "";
  panelMsg.textContent = "";
  panel.classList.remove("visible");
  activePlaceNum = null;
});
</script>
</body>
</html>
